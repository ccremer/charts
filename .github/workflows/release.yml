name: Release Charts

on:
  push:
    branches:
    - master

jobs:
  gh-pages:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - uses: actions/setup-go@v2-beta
      with:
        go-version: '^1.13.8'

    - uses: azure/setup-helm@v1
      with:
        version: v3.1.1

    - uses: actions/cache@v1
      with:
        path: /home/runner/go/pkg/mod
        key: go-mod

    - name: Configure Git
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

    - name: Run Chart unit tests
      run: |
        find . -type f -name go.mod | xargs -I % bash -c 'cd "$(dirname %)" && go test ./...'

    # We need to downgrade, as long as https://github.com/helm/chart-releaser isn't released yet.
    - uses: azure/setup-helm@v1
      with:
        version: v2.16.3

    - name: Run chart-releaser
      uses: helm/chart-releaser-action@v1.0.0-alpha.2
      env:
        CR_TOKEN: "${{ secrets.CR_TOKEN }}"
